<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Token</title>
</head>
<body style="background-color: #ef5afa;">
<th:block th:replace="/fragments/header"></th:block>
<div class="container">
    <h1>Token Info</h1>
    User-ID :<BR>
    <input type="text" id="userId" name="userId" size="100" readonly /> <BR>
    User-Name :<BR>
    <input type="text" id="userName" name="userName" size="100" readonly /> <BR>
    Access-Token :<BR>
    <textarea aria-readonly="true" id="access_token" name="access_token" cols="100" rows="2"></textarea> <BR>
    Access-Token (Decoded) :<BR>
    <textarea aria-readonly="true" id="decoded_access_token" name="decoded_access_token" cols="100" rows="12"></textarea> <BR>
    Request-Party-Token (ê¶Œí•œí† í°) :<BR>
    <textarea aria-readonly="true" id="rp_token" name="rp_token" cols="100" rows="12"></textarea> <BR>
    ID-Token :<BR>
    <textarea aria-readonly="true" id="id_token" name="id_token" cols="100" rows="2"></textarea> <BR>
    ID-Token (Decoded) :<BR>
    <textarea aria-readonly="true" id="decoded_id_token" name="decoded_id_token" cols="100" rows="12"></textarea> <BR>
    Refresh-Token :<BR>
    <textarea aria-readonly="true" id="refresh_token" name="refresh_token" cols="100" rows="2"></textarea> <BR>
    Refresh-Token (Decoded) :<BR>
    <textarea aria-readonly="true" id="decoded_refresh_token" name="decoded_refresh_token" cols="100" rows="12"></textarea> <BR>
</div>

<script>
    $.ajax({
        url: '/get-token',
        method: 'POST',
        success: function(data, status, xhr) {
            console.log('data=' + JSON.stringify(data));
            //
            $('#id_token').empty();
            $('#access_token').empty();
            $('#refresh_token').empty();
            $('#rp_token').empty();
            //
            $('#userId').val(data.userId);
            $('#userName').val(data.userName);
            $('#id_token').text(data.id_token);
            $('#access_token').text(data.access_token);
            $('#refresh_token').text(data.refresh_token);

            //
            decodeJWT("id_token", "decoded_id_token");
            decodeJWT("access_token", "decoded_access_token");
            decodeJWT("refresh_token", "decoded_refresh_token");

            try {
                console.log('rp_token1=' + data.rp_token);
                console.log('rp_token1=' + JSON.stringify(data.rp_token));
                const pretty = js_beautify(JSON.stringify(data.rp_token, null, 2));
                $('#rp_token').text(pretty);
                console.log('rp_token2=' + pretty);
            } catch(e) {
                $('#rp_token').text('*** Invalid JSON ***');
            }
        },
        error: function(data, status, xhr) {
            console.log(err);
        }
    });

    function base64UrlDecode(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4;
      if (pad) str += '='.repeat(4 - pad);
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch (e) {
        return '[ë””ì½”ë”© ì‹¤íŒ¨]';
      }
    }

    function decodeJWT(encoded_field, decoded_field) {
      const input = document.getElementById(encoded_field).value.trim();
      const resultArea = document.getElementById(decoded_field);

      if (!input) {
        resultArea.value = 'âš ï¸ JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
      }

      const parts = input.split('.');
      if (parts.length !== 3) {
        resultArea.value = 'âš ï¸ JWTëŠ” 3ê°œì˜ ì (.)ìœ¼ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
        return;
      }

      try {
        const header = JSON.parse(base64UrlDecode(parts[0]));
        const payload = JSON.parse(base64UrlDecode(parts[1]));

        resultArea.value =
          'ğŸ“Œ [Header]\n' +
          JSON.stringify(header, null, 2) +
          '\n\nğŸ“Œ [Payload]\n' +
          JSON.stringify(payload, null, 2);
      } catch (e) {
        resultArea.value = 'âŒ JSON íŒŒì‹± ì˜¤ë¥˜: ì˜ëª»ëœ JWT í† í°ì…ë‹ˆë‹¤.';
      }
    }
</script>
</body>
</html>
